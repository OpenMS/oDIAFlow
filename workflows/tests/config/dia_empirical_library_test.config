// Test configuration for DIA_EMPIRICAL_LIBRARY workflow
// Uses test data with reduced parameters for faster execution

params {
  // Input files - using relative path from project root (execution context)
  // Since we execute from project root, these paths should work
  dda_glob = "modules/tests/data/test_raw*.mzML.gz"  // Using DIA files as DDA for testing (Sage can search them)
  dia_glob = "modules/tests/data/test_raw*.mzML.gz"
  fasta = "modules/tests/data/uniprotkb_organism_id_1314_AND_reviewed_2025_11_18.fasta"
  swath_windows = "modules/tests/data/strep_win.txt"
  irt_traml = null  // Optional, not using for this test
  irt_nonlinear_traml = null  // Optional, not using for this test
  
  // Use SQLite format (not parquet) for this test
  use_parquet = false
  
  // Sage search parameters
  sage {
    // Database search
    bucket_size = 16384
    missed_cleavages = 1
    min_len = 5
    max_len = 50
    cleave_at = "KR"
    restrict = "P"
    c_terminal = true
    semi_enzymatic = false
    
    // Fragment settings
    fragment_min_mz = 150.0
    fragment_max_mz = 2000.0
    peptide_min_mass = 500.0
    peptide_max_mass = 5000.0
    ion_kinds = '["b", "y"]'
    min_ion_index = 2
    
    // Modifications
    static_mods = '{"C": 57.0216}'  // Carbamidomethylation
    variable_mods = '{"M": [15.9949]}'  // Oxidation
    max_variable_mods = 2
    
    // Decoys
    decoy_tag = "rev_"
    generate_decoys = true
    
    // Tolerances
    precursor_tol_ppm_low = -50.0
    precursor_tol_ppm_high = 50.0
    fragment_tol_ppm_low = -20.0
    fragment_tol_ppm_high = 20.0
    
    // Charge states and isotopes
    precursor_charge_min = 2
    precursor_charge_max = 4
    isotope_errors_min = -1
    isotope_errors_max = 3
    
    // Peak picking
    deisotope = true
    chimera = false
    wide_window = false
    min_peaks = 15
    max_peaks = 150
    max_fragment_charge = 2
    min_matched_peaks = 4
    
    // Output
    report_psms = 1
    annotate_matches = true
    write_pin = false
    parquet = false
    batch_size = 0
    predict_rt = true
    
    // Quantification
    tmt = 'null'
    tmt_level = 3
    tmt_sn = false
    lfq = false
    lfq_peak_scoring = "Hybrid"
    lfq_integration = "Sum"
    lfq_spectral_angle = 0.7
    lfq_ppm_tolerance = 5.0
    lfq_combine_charge_states = true
    
    // Logging
    log_level = "info"
  }
  
  // EasyPQP parameters
  easypqp {
    // Filter criteria
    psm_fdr_threshold = 0.01
    peptide_fdr_threshold = 0.01
    protein_fdr_threshold = 0.01
    
    // Library generation
    min_peptides = 1
    max_peptides = 6
    consensus_spectrum = "best_replicate"
    
    // RT normalization
    rt_normalization = false  // Will use iRT if available
  }
  
  // OpenSwathAssayGenerator parameters
  osag {
    min_transitions = 6
    max_transitions = 6
    allowed_fragment_charges = "1,2,3,4"
    allowed_fragment_types = "b,y"
    out_type = "pqp"
    debug = 0
  }
  
  // OpenSwathDecoyGenerator parameters
  osdg {
    method = "shuffle"
  }
  
  // OpenSwathWorkflow parameters
  osw {
    // Extraction window settings - relaxed for test data
    rt_window_sec   = 600
    extra_rt_window_sec = 2000
    mz_win          = 50
    mz_unit         = "ppm"
    ms1_mz_win      = 50
    ms1_mz_unit     = "ppm"

    // diaPASEF disabled for standard DIA test
    pasef           = false
    im_window       = -1
    im_extraction_window_ms1 = -1
    irt_im_extraction_window = -1

    // Calibration - relaxed for test data
    auto_irt        = true
    min_rsq         = 0.1
    linear_irt_bins = 100
    linear_irt_peptides_per_bin = 500
    nonlinear_irt_bins = 1000
    nonlinear_irt_peptides_per_bin = 1000

    // Processing options
    cache_in_mem    = true 
    batch_size      = 1000    
    debug           = 0
  }
  
  // Arycal parameters
  arycal {
    method = "fft-dtw"
    xic_file_type = "sqmass"  // Will be auto-detected
    features_file_type = "osw"  // Will be auto-detected
    target_fdr = 0.01
    max_fdr_quality = 0.05
    max_rt_diff = 60
    fdr_policy = "any-score"
  }
  
  // PyProphet parameters
  pyprophet {
    peakgroup_scoring {
      classifier      = "LDA"
      level           = "ms2"
      threads         = 2
      ss_num_iter     = 3
      ss_initial_fdr  = 0.15
      ss_iteration_fdr = 0.05
      ss_main_score    = 'var_xcorr_shape'
      xeval_num_iter   = 3
    }
    
    alignment_scoring {
      level           = "ms2"
      classifier      = "LDA"
      ss_num_iter     = 3
      ss_initial_fdr  = 0.15
      ss_iteration_fdr = 0.05
      ss_main_score    = 'var_xcorr_shape'
      xeval_num_iter   = 3
    }
  }
  
  pyprophet_export_tsv {
    max_rs_peakgroup_qvalue = 0.05
    max_global_peptide_qvalue = 0.01
    max_global_protein_qvalue = 0.01
  }
}

process {
  // Sage search
  withName: 'OPEN_SWATH_E2E:SAGE_SEARCH' {
    cpus = 4
    memory = '8.GB'
    time = '2.h'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // EasyPQP convert
  withName: 'OPEN_SWATH_E2E:EASYPQP_CONVERTSAGE' {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // EasyPQP library
  withName: 'OPEN_SWATH_E2E:EASYPQP_LIBRARY' {
    ext.args = '--nofdr --psm_fdr_threshold 1.0 --peptide_fdr_threshold 1.0 --protein_fdr_threshold 1.0 --rt_psm_fdr_threshold 1.0 --min_peptides 1'
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // OpenSwathAssayGenerator
  withName: 'OPEN_SWATH_E2E:OPENSWATHASSAYGENERATOR' {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // OpenSwathDecoyGenerator
  withName: 'OPEN_SWATH_E2E:OPENSWATHDECOYGENERATOR' {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // OpenSwathWorkflow
  withName: 'OPEN_SWATH_E2E:OPENSWATHWORKFLOW' {
    ext.args = '-sort_swath_maps -Calibration:RTNormalization:alignmentMethod lowess -Calibration:RTNormalization:outlierMethod none -Calibration:RTNormalization:lowess:span 0.05 -Calibration:RTNormalization:NrRTBins 1 -Calibration:RTNormalization:MinPeptidesPerBin 1 -Calibration:RTNormalization:MinBinsFilled 1 -Calibration:RTNormalization:OverallQualityCutoff 0.5 '
    cpus = 4
    memory = '8.GB'
    time = '1.h'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // PyProphet merge
  withName: 'OPEN_SWATH_E2E:PYPROPHET_MERGE' {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // Arycal
  withName: 'OPEN_SWATH_E2E:ARYCAL' {
    cpus = 4
    memory = '8.GB'
    time = '1.h'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // PyProphet alignment scoring
  withName: 'OPEN_SWATH_E2E:PYPROPHET_ALIGNMENT_SCORING' {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // PyProphet OSW subworkflow
  withName: 'OPEN_SWATH_E2E:PYPROPHET_OSW_FULL:.*' {
    cpus = 2
    memory = '4.GB'
    time = '1.h'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
  
  // Calibration report
  withName: 'OPEN_SWATH_E2E:PYPROPHET_CALIBRATION_REPORT' {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
}

profiles {
  docker {
    docker.enabled = true
    docker.runOptions = '-u $(id -u):$(id -g) --env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
    singularity.enabled = false
  }
  
  singularity {
    singularity.enabled = true
    singularity.autoMounts = true
    docker.enabled = false
  }
}
