/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    oDIAFlow Test Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Minimal configuration for pipeline testing with small datasets.
    
    Usage: 
        nextflow run main.nf -profile docker,test
        nextflow run main.nf -profile singularity,test
----------------------------------------------------------------------------------------
*/

params {
    // Test mode settings
    config_profile_name        = 'Test profile'
    config_profile_description = 'Minimal test dataset for pipeline validation'

    // Resource limits for test runs
    max_cpus   = 4
    max_memory = '16.GB'
    max_time   = '2.h'

    // Test data paths (update these to point to your test data)
    // These can be local paths or URLs
    dia_glob           = "${projectDir}/test_data/dia/*.mzML"
    dda_glob           = "${projectDir}/test_data/dda/*.mzML"
    fasta              = "${projectDir}/test_data/database.fasta"
    
    // Skip DIA-for-library search in tests for speed
    dia_for_lib_glob   = null

    // Output
    outdir             = "test_results"
    
    // Save all outputs for debugging
    save_intermediates = true
    save_logs          = true
    save_calibration   = true
    save_reports       = true
    save_sqmass        = true
    save_merged_osw    = true
    
    // Sage test settings - relaxed tolerances
    sage {
        precursor_tol_ppm_low  = -50.0
        precursor_tol_ppm_high = 50.0
        fragment_tol_ppm_low   = -20.0
        fragment_tol_ppm_high  = 20.0
        missed_cleavages       = 1      // Fewer for speed
        max_variable_mods      = 1      // Fewer for speed
    }

    // OpenSWATH test settings - relaxed for test data
    osw {
        rt_window_sec          = 400    // Wider window for test
        min_rsq                = 0.8    // Lower threshold for test data
        linear_irt_peptides_per_bin = 500  // More peptides per bin
    }
    
    // PyProphet test settings - faster iterations
    pyprophet {
        peakgroup_scoring {
            ss_num_iter        = 3
            xeval_num_iter     = 3
        }
        alignment_scoring {
            ss_num_iter        = 3
            xeval_num_iter     = 3
        }
    }
}

// Reduce resources for test profile
process {
    cpus   = { 2 * task.attempt }
    memory = { 4.GB * task.attempt }
    time   = { 1.h * task.attempt }

    withName: '.*SAGE_SEARCH.*' {
        cpus   = 4
        memory = '8.GB'
        time   = '1.h'
    }

    withName: '.*OPENSWATHWORKFLOW' {
        cpus   = 4
        memory = '8.GB'
        time   = '2.h'
        maxForks = 1
    }

    withName: '.*ARYCAL' {
        cpus   = 4
        memory = '8.GB'
        time   = '1.h'
    }
}
