/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    oDIAFlow Module Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Centralized configuration for process-specific arguments, publish directories,
    and container options. This file controls HOW processes run (arguments, outputs)
    while resource configs control WHERE/HOW MUCH (cpu, memory, time).
    
    Available keys:
        ext.args            = Additional arguments appended to command
        ext.args2           = Second set of arguments (multi-tool modules)
        ext.prefix          = File name prefix for output files
        publishDir          = Output directory settings
        containerOptions    = Container-specific runtime options
----------------------------------------------------------------------------------------
*/

// Common container options for Python-based tools
def pythonContainerOpts = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'

process {
    // =========================================================================
    // FDRBENCH - Entrapment Database Generation
    // =========================================================================
    withName: '.*FDRBENCH_ENTRAPMENT' {
        publishDir = [
            [
                path: { "${params.outdir}/fdrbench" },
                mode: params.publish_dir_mode,
                pattern: '*.fasta',
                enabled:  { -> params.save_intermediates }
            ],
            [
                path: { "${params.outdir}/fdrbench" },
                mode: params.publish_dir_mode,
                pattern: '*.txt',
                enabled:  { -> params.save_intermediates }
            ]
        ]
    }

    withName: '.*FDRBENCH_FDP_CALCULATION' {
        publishDir = [
            path: { "${params.outdir}/fdrbench/fdp" },
            mode: params.publish_dir_mode,
            pattern: '*.csv',
            enabled: true
        ]
    }

    // =========================================================================
    // SAGE SEARCH
    // =========================================================================
    withName: '.*SAGE_SEARCH.*' {
        containerOptions = pythonContainerOpts
        // Retry on OOM (137=SIGKILL, 139=SIGSEGV, 1=general error from missing output)
        // Memory increases by 1.5x on each retry
        errorStrategy = { task.exitStatus in [1, 137, 139, 140] ? 'retry' : 'finish' }
        maxRetries = 2
        memory = { 48.GB * Math.pow(1.5, task.attempt - 1) }
        publishDir = [
            [
                path: { "${params.outdir}/sage" },
                mode: params.publish_dir_mode,
                pattern: '*.{tsv,json,parquet}',
                enabled:  { -> params.save_intermediates }
            ],
            [
                path: { "${params.outdir}/reports/sage" },
                mode: params.publish_dir_mode,
                pattern: '*.html',
                enabled: params.save_reports
            ],
            [
                path: { "${params.outdir}/logs/sage/" },
                mode: params.publish_dir_mode,
                pattern: 'sage_search_*.log',
                enabled: params.save_logs
            ]
        ]
    }

    withName: '.*SAGE_COMBINE_RESULTS' {
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/sage" },
                mode: params.publish_dir_mode,
                pattern: '*.tsv',
                enabled:  { -> params.save_intermediates }
            ],
            [
                path: { "${params.outdir}/logs/sage/" },
                mode: params.publish_dir_mode,
                pattern: 'sage_combine_results.log',
                enabled: params.save_logs
            ]
        ]
    }

    // =========================================================================
    // EASYPQP
    // =========================================================================
    withName: '.*EASYPQP_CONVERTSAGE' {
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/easypqp/converted" },
                mode: params.publish_dir_mode,
                pattern: '*pkl',
                enabled:  { -> params.save_intermediates }
            ]
        ]
    }

    withName: '.*EASYPQP_LIBRARY' {
        ext.args = '--nofdr'  // Skip FDR filtering
        containerOptions = pythonContainerOpts
        publishDir = [
            [
            path: { "${params.outdir}/easypqp/library" },
            mode: params.publish_dir_mode,
            pattern: 'easypqp_library.tsv',
            enabled: true
            ],
            [
                path: { "${params.outdir}/easypqp/run_peaks" },
                mode: params.publish_dir_mode,
                pattern: '*_run_peaks.tsv',
                enabled: { -> params.save_intermediates }
            ]
        ]
    }

    withName: '.*EASYPQP_REDUCE' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/irt/linear" },
            mode: params.publish_dir_mode,
            pattern: '*.irt.linear.pqp',
            enabled: true
        ]
    }

    // =========================================================================
    // OPENSWATH TOOLS
    // =========================================================================
    withName: '.*OPENSWATHASSAYGENERATOR_NAMED' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/irt/nonlinear" },
            mode: params.publish_dir_mode,
            pattern: '*.pqp',
            enabled: true
        ]
    }

    withName: '.*OPENSWATHASSAYGENERATOR' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/library" },
            mode: params.publish_dir_mode,
            pattern: 'library_targets.*',
            enabled:  { -> params.save_intermediates }
        ]
    }

    withName: '.*OPENSWATHDECOYGENERATOR' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/library" },
            mode: params.publish_dir_mode,
            pattern: 'library.*',
            enabled: true
        ]
    }

    withName: '.*OPENSWATHWORKFLOW' {
        // Default args - can be overridden in user config
        ext.args = '-sort_swath_maps -Calibration:RTNormalization:alignmentMethod lowess -Calibration:RTNormalization:outlierMethod none'
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/openswath/osw" },
                mode: params.publish_dir_mode,
                pattern: '*.osw',
                enabled:  { -> params.save_intermediates }
            ],
            [
                path: { "${params.outdir}/openswath/chromatograms" },
                mode: params.publish_dir_mode,
                pattern: '*.sqMass',
                enabled: params.save_sqmass
            ],
            [
                path: { "${params.outdir}/openswath/debug" },
                mode: params.publish_dir_mode,
                pattern: '*_debug_calibration*',
                enabled:  { -> params.save_intermediates }
            ],
            [
                path: { "${params.outdir}/logs/openswath/" },
                mode: params.publish_dir_mode,
                pattern: '*_openswath.log',
                enabled: params.save_logs
            ]
        ]
    }

    // =========================================================================
    // PYPROPHET
    // =========================================================================
    withName: '.*PYPROPHET_MERGE' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/pyprophet" },
            mode: params.publish_dir_mode,
            pattern: 'merged*.osw',
            enabled: params.save_merged_osw
        ]
    }

    withName: '.*PYPROPHET_PEAKGROUP_SCORING' {
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/reports/scoring" },
                mode: params.publish_dir_mode,
                pattern: '*.pdf',
                enabled: params.save_reports
            ]
        ]
    }

    withName: '.*PYPROPHET_ALIGNMENT_SCORING' {
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/reports/alignment" },
                mode: params.publish_dir_mode,
                pattern: '*.pdf',
                enabled: params.save_reports
            ]
        ]
    }

    withName: '.*PYPROPHET_INFER_PEPTIDE' {
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/reports/peptide_inference" },
                mode: params.publish_dir_mode,
                pattern: '*.pdf',
                enabled: params.save_reports
            ]
        ]
    }

    withName: '.*PYPROPHET_INFER_PROTEIN' {
        containerOptions = pythonContainerOpts
        publishDir = [
            [
                path: { "${params.outdir}/reports/protein_inference" },
                mode: params.publish_dir_mode,
                pattern: '*.pdf',
                enabled: params.save_reports
            ]
        ]
    }

    withName: '.*PYPROPHET_EXPORT_TSV' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/results" },
            mode: params.publish_dir_mode,
            pattern: '*.tsv',
            enabled: true
        ]
    }

    withName: '.*PYPROPHET_CALIBRATION_REPORT' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/reports/calibration" },
            mode: params.publish_dir_mode,
            pattern: '*.pdf',
            enabled: params.save_calibration
        ]
    }

    withName: '.*PYPROPHET_EXPORT_RESULTS_REPORT' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/reports/analysis" },
            mode: params.publish_dir_mode,
            pattern: '*.pdf',
            enabled: true
        ]
    }

    // =========================================================================
    // ARYCAL
    // =========================================================================
    // withName: '.*ARYCAL' {
    //     containerOptions = '--privileged ' + pythonContainerOpts
    //     publishDir = [
    //         [
    //             path: { "${params.outdir}/arycal" },
    //             mode: params.publish_dir_mode,
    //             pattern: '*.osw',
    //             enabled: params.save_merged_osw
    //         ]
    //     ]
    // }

    // =========================================================================
    // FILE CONVERSION
    // =========================================================================
    withName: '.*DIAPYSEF_TDF_TO_MZML' {
        containerOptions = pythonContainerOpts
        publishDir = [
            path: { "${params.outdir}/mzml" },
            mode: params.publish_dir_mode,
            pattern: '*.mzML',
            enabled:  { -> params.save_intermediates }
        ]
    }

    // =========================================================================
    // LOGS (applies to all processes when enabled)
    // =========================================================================
    withLabel: 'process_.*' {
        publishDir = [
            path: { "${params.outdir}/logs/" },
            mode: params.publish_dir_mode,
            pattern: '*.log',
            enabled: params.save_logs
        ]
    }
}
