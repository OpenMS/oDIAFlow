/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    oDIAFlow - OpenSWATH DIA Analysis Pipeline
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    GitHub: https://github.com/OpenMS/oDIAFlow
    
    Default configuration for all execution environments.
    Override these defaults using -params-file, -c, or command-line --param options.
----------------------------------------------------------------------------------------
*/

// =====================================================================================
// GLOBAL PARAMETERS
// =====================================================================================

params {

    // -------------------------------------------------------------------------
    // Workflow Selection
    // -------------------------------------------------------------------------
    workflow            = 'empirical'   // 'empirical' (DDA+DIA) or 'insilico' (predicted library)
    
    // -------------------------------------------------------------------------
    // Input Files
    // -------------------------------------------------------------------------
    dia_glob            = null          // DIA files: "data/dia/*.mzML" or "data/dia/*.d"
    dda_glob            = null          // DDA files for library: "data/dda/*.mzML" (empirical workflow)
                                        // Supports comma-separated globs: "/path1/*.d, /path2/*_diatracer.mzML"
    dia_for_lib_glob    = null          // Optional: DIA files for library: "data/dia/*.d" (hybrid search)
                                        // Supports comma-separated globs for multiple paths
    transition_tsv      = null          // Assay library TSV (insilico workflow): "lib/assays.tsv"
    fasta               = null          // Protein database: "db/uniprot.fasta"
    irt_traml           = null          // iRT calibration library (linear): "lib/iRTassays.TraML"
    irt_nonlinear_traml = null          // iRT calibration library (nonlinear): "lib/iRTassays_nonlinear.TraML"
    swath_windows       = null          // SWATH window definitions: "lib/swath32.txt"
    
    // -------------------------------------------------------------------------
    // iRT Calibration Options
    // -------------------------------------------------------------------------
    use_runspecific_irts = true         // Use per-run iRT PQPs when available (from EasyPQP reduce)
    use_auto_irts       = true          // Auto-sample input PQP for iRT calibration
    
    // Pseudo-spectra suffix pattern: regex to strip from pseudo-spectra filenames
    // to match them with original DIA files. Common patterns:
    //   DIA-Umpire: _Q1, _Q2, _Q3 (Q1 is highest quality, preferred when multiple match)
    //   diaTracer: _diatracer
    // The pipeline automatically handles these common suffixes. Set this parameter
    // only if you have custom pseudo-spectra naming conventions.
    // Example: '(_Q[123]|_diatracer)' would strip these suffixes
    // When multiple pseudo-spectra match a single DIA file, Q1 is preferred over Q2/Q3.
    irt_pseudospectra_suffix = null     // Set to regex pattern for custom suffixes
    
    // -------------------------------------------------------------------------
    // Output Configuration
    // -------------------------------------------------------------------------
    outdir              = "results"     // Output directory
    publish_dir_mode    = "copy"        // File publishing mode: copy, symlink, move
    use_parquet         = false         // Use Parquet format for PyProphet (vs SQLite)
    
    // Output file control
    save_logs           = true          // Save tool execution logs
    save_calibration    = true          // Save PyProphet calibration QC reports
    save_reports        = true          // Save scoring/inference PDF reports
    save_sqmass         = true          // Save sqMass XIC chromatogram files
    save_merged_osw     = true          // Save merged OSW/parquet files
    save_intermediates  = false         // Save intermediate files (per-run OSW, pickles, etc.)
    cleanup_work_dir    = false         // Delete work/ directory on completion
    
    // -------------------------------------------------------------------------
    // Runtime
    // -------------------------------------------------------------------------
    container           = "ghcr.io/openswath/openswath:dev"
    max_cpus            = 64            // Maximum CPUs per process
    max_memory          = '256.GB'      // Maximum memory per process
    max_time            = '72.h'        // Maximum time per process

    // =========================================================================
    // TOOL-SPECIFIC PARAMETERS
    // =========================================================================

    // -------------------------------------------------------------------------
    // FDRBench - Entrapment Database Generation & FDP Calculation
    // -------------------------------------------------------------------------
    // FDRBench is included in the OpenSWATH Docker/Singularity container.
    // For local execution without containers, ensure fdrbench is on your PATH.
    fdrbench {
        // Enable/disable FDRBench entrapment
        enabled             = false         // Set true to add entrapment sequences to FASTA before Sage search
        
        // Entrapment generation settings
        level               = "protein"     // 'peptide' or 'protein' level entrapment
        i2l                 = true          // Convert I to L for matching
        diann_compatible    = true          // Generate DIA-NN compatible format
        uniprot_format      = true          // Parse UniProt-style FASTA headers
        
        // Enzyme settings (should match Sage settings)
        enzyme              = 2             // 0:Non-specific, 1:Trypsin, 2:Trypsin (no P), 3:Arg-C, 4:Arg-C (no P), 5:Arg-N, 6:Glu-C, 7:Lys-C, 8:NoCut
        missed_cleavages    = 2             // Max missed cleavages
        min_length          = 7             // Min peptide length
        max_length          = 35            // Max peptide length
        
        // Entrapment method
        fold                = 1             // Number of entrapment folds (1 = 1:1 ratio)
        method              = 0             // 0:shuffle, 1:swap
        entrapment_label    = "_p_target"   // Label for entrapment sequences
        entrapment_pos      = 1             // 0:start, 1:end (default)
        
        // Multi-species entrapment (alternative to shuffling)
        foreign_species     = null          // Comma-separated list of foreign species FASTA paths
        
        // Quality control options
        check_duplicates    = true          // Check for duplicates and random shuffling
        no_shared_peptides  = false         // No shared peptides between entrapment and target
        add_decoy           = false         // Add decoys to output (usually Sage handles this)
        clip_n_m            = false         // Clip N-terminal M
        swap_order          = false         // Reverse order of generated sequences
        fix_nc              = "c"           // Fix N/C terminal: 'n', 'c', 'nc', or null
        pick                = "first"       // Protein selection: 'first', 'last', 'random'
        
        // Reproducibility
        fix_seed            = false         // Use fixed random seed
        seed                = null          // Random seed value
        
        // FDP calculation settings (post-search analysis)
        fdp_enabled         = false         // Enable FDP calculation after search
        fdp_score_column    = "score"       // Column name for ranking score
        fdp_score_order     = 0             // 0:lower is better, 1:higher is better
        decoy_label         = "rev_"        // Decoy label (should match Sage)
        decoy_pos           = 0             // 0:start, 1:end
    }

    // -------------------------------------------------------------------------
    // SAGE Search Engine
    // -------------------------------------------------------------------------
    sage {
        // Search mode
        search_dia_for_lib  = false     // Enable hybrid DDA+DIA library building

        // Database/enzyme settings
        missed_cleavages    = 2
        cleave_at           = "KR"
        restrict            = "P"       // Restrict cleavage (P = no cut before proline)
        c_terminal          = null      // C-terminal cleavage (null = trypsin default)
        semi_enzymatic      = null      // Semi-enzymatic search
        min_len             = null      // Min peptide length (null = default)
        max_len             = null      // Max peptide length (null = default)

        // Mass tolerances
        precursor_tol_ppm_low  = -50.0
        precursor_tol_ppm_high = 50.0
        fragment_tol_ppm_low   = -10.0
        fragment_tol_ppm_high  = 10.0

        // Modifications (JSON format)
        static_mods         = '{"C": 57.0216}'      // Carbamidomethyl on Cys
        variable_mods       = '{"M": [15.9949]}'    // Oxidation on Met
        max_variable_mods   = 2

        // Mass ranges
        fragment_min_mz     = 150.0
        fragment_max_mz     = 1500.0
        peptide_min_mass    = 500.0
        peptide_max_mass    = 5000.0

        // Ion types and charges
        ion_kinds           = '["b", "y"]'
        min_ion_index       = 2
        precursor_charge_min = 2
        precursor_charge_max = 4
        max_fragment_charge = 1

        // Isotope handling
        isotope_errors_min  = -1
        isotope_errors_max  = 3
        deisotope           = true

        // Decoys
        decoy_tag           = "rev_"
        generate_decoys     = true

        // Search parameters
        chimera             = false     // DDA chimera search
        wide_window         = false     // DDA wide window search
        dia_chimera         = true      // DIA chimera search (when search_dia_for_lib=true)
        dia_wide_window     = true      // DIA wide window search

        min_peaks           = 15
        max_peaks           = 150
        min_matched_peaks   = 4
        report_psms         = 1
        predict_rt          = true

        // Quantification
        tmt                 = null
        tmt_level           = 3
        tmt_sn              = false
        lfq                 = true
        lfq_peak_scoring    = "Hybrid"
        lfq_integration     = "Sum"
        lfq_spectral_angle  = 0.7
        lfq_ppm_tolerance   = 5.0
        lfq_combine_charge_states = true

        // Output options
        annotate_matches    = true      // Generate matched_fragments file
        write_pin           = false     // Generate Percolator .pin files
        parquet             = false     // Write parquet instead of TSV
        write_report        = true

        // Runtime
        batch_size          = 0         // 0 = auto (CPUs/2)
        bucket_size         = 16384
        log_level           = "info"    // trace, debug, info, warning, error
    }

    // -------------------------------------------------------------------------
    // EasyPQP Library Generation
    // -------------------------------------------------------------------------
    easypqp {
        reduce {
            bins            = 10        // Number of RT bins for linear iRT PQP
            peptides        = 20        // Min peptides per bin
        }
    }

    // -------------------------------------------------------------------------
    // OpenSwathAssayGenerator
    // -------------------------------------------------------------------------
    osag {
        out_type            = "pqp"
        min_transitions     = 6
        max_transitions     = 6
        allowed_fragment_types   = "b,y"
        allowed_fragment_charges = "1,2,3,4"
        debug               = 0
    }

    // -------------------------------------------------------------------------
    // OpenSwathDecoyGenerator
    // -------------------------------------------------------------------------
    osdg {
        out_type            = "pqp"
        method              = "shuffle"
        decoy_tag           = "DECOY_"
        allowed_fragment_types   = "b,y"
        allowed_fragment_charges = "1,2,3,4"
        switch_kr           = true
        debug               = 0
    }

    // -------------------------------------------------------------------------
    // OpenSwathWorkflow
    // -------------------------------------------------------------------------
    osw {
        // Extraction windows
        rt_window_sec       = 600
        extra_rt_window_sec = 200       // Extra context for alignment
        mz_win              = 25
        mz_unit             = "ppm"     // "ppm" or "th"
        ms1_mz_win          = 25
        ms1_mz_unit         = "ppm"

        // Ion mobility (diaPASEF)
        pasef               = false     // Enable for diaPASEF data
        im_window           = 0.06
        im_extraction_window_ms1 = 0.06
        irt_im_extraction_window = 0.1

        // iRT calibration
        auto_irt            = true
        min_rsq             = 0.95
        linear_irt_bins     = 100
        linear_irt_peptides_per_bin = 5
        nonlinear_irt_bins  = 2000
        nonlinear_irt_peptides_per_bin = 50

        // Processing
        cache_in_mem        = true
        batch_size          = 1000
        debug               = 0
    }

    // -------------------------------------------------------------------------
    // Arycal Alignment
    // -------------------------------------------------------------------------
    arycal {
        // XIC settings
        xic_include_precursor = false
        xic_num_isotopes    = 3
        xic_file_type       = null      // null = auto-detect

        // Features settings
        features_file_type  = null      // null = auto-detect

        // Filters
        include_decoys      = false
        include_identifying_transitions = false
        max_score_ms2_qvalue = 1.0
        precursor_ids       = null

        // Alignment
        batch_size          = 1000
        alignment_method    = "fftdtw"
        reference_type      = "star"
        reference_run       = null      // null = auto-select
        use_tic             = true

        // Smoothing
        sgolay_window       = 11
        sgolay_order        = 3

        // RT mapping
        rt_mapping_tolerance = 10.0
        decoy_peak_mapping_method = "shuffle"
        decoy_window_size   = 30

        // Output
        compute_scores      = true
        scores_output_file  = null
        retain_alignment_path = false
        log_level           = "info"
    }

    // -------------------------------------------------------------------------
    // PyProphet Scoring & Inference
    // -------------------------------------------------------------------------
    pyprophet {
        alignment_scoring {
            classifier      = "SVM"
            level           = "alignment"
            threads         = 4
            ss_num_iter     = 3
            ss_initial_fdr  = 0.15
            ss_iteration_fdr = 0.05
            ss_main_score   = 'auto'
            xeval_num_iter  = 3
        }

        peakgroup_scoring {
            classifier      = "XGBoost"
            level           = "ms1ms2"
            threads         = 4
            ss_num_iter     = 10
            ss_initial_fdr  = 0.15
            ss_iteration_fdr = 0.05
            ss_main_score   = 'auto'
            xeval_num_iter  = 10
        }

        transition_scoring {
            classifier      = "XGBoost"
            level           = "transition"
            threads         = 4
            ss_num_iter     = 10
            ss_initial_fdr  = 0.15
            ss_iteration_fdr = 0.05
            ss_main_score   = 'auto'
            xeval_num_iter  = 10
            ipf_max_peakgroup_rank = 1
            ipf_max_peakgroup_pep = 0.7
            ipf_max_transition_isotope_overlap = 0.5
            ipf_min_transition_sn = -1
        }

        infer_peptidoforms {
            ipf_ms1_scoring = false
            ipf_ms2_scoring = false
            ipf_max_precursor_pep = 0.7
            ipf_max_peakgroup_pep = 0.7
            ipf_max_precursor_peakgroup_pep = 0.4
            ipf_max_transition_pep = 0.6
            propagate_signal_across_runs = true
            ipf_max_alignment_pep = 0.4
            across_run_confidence_threshold = 0.5
        }

        pyprophet_export_tsv {
            max_rs_peakgroup_qvalue = 0.05
            max_global_peptide_qvalue = 0.01
            max_global_protein_qvalue = 0.01
        }
    }
}

// =====================================================================================
// CONFIGURATION INCLUDES
// =====================================================================================

// Base resource labels (process_low, process_medium, process_high, etc.)
includeConfig 'conf/base.config'

// Module-specific arguments, publishDir, and container options
includeConfig 'conf/modules.config'

// Execution profiles (docker, singularity, slurm, etc.)
includeConfig 'conf/profiles.config'

// =====================================================================================
// DEFAULT PROCESS SETTINGS
// =====================================================================================

process {
    container = params.container
    
    // Error handling
    errorStrategy = { task.exitStatus in ((130..145) + 104 + 175) ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'
}

// =====================================================================================
// MANIFEST
// =====================================================================================

manifest {
    name            = 'OpenMS/oDIAFlow'
    author          = 'OpenMS Team'
    homePage        = 'https://github.com/OpenMS/oDIAFlow'
    description     = 'OpenSWATH-based DIA proteomics analysis pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}

// =====================================================================================
// TIMELINE, REPORT, AND TRACE
// =====================================================================================

def timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline_${timestamp}.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report_${timestamp}.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/trace_${timestamp}.txt"
    fields  = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,workdir,scratch,error_action'
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/dag_${timestamp}.html"
}

// =====================================================================================
// VALIDATION
// =====================================================================================

// Validate parameters against schema
validation {
    help {
        enabled = true
    }
}
