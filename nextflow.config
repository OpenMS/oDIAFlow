/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    bigbio/quantms Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
----------------------------------------------------------------------------------------
*/

// Global default params, used in configs
params {

    // Workflow selection
    workflow          = 'empirical'  // 'empirical' (DDA+DIA) or 'insilico' (predicted library)
    
    // INPUTS
    dia_glob          = null        // e.g. "data/dia/*.mzML"
    dda_glob          = null        // e.g. "data/dda/*.mzML"
    dia_for_lib_glob  = null        // e.g. "data/dia/*.mzML" (optional: search DIA data with Sage for library building)
    transition_tsv    = null        // e.g. "lib/assays.tsv" (for insilico workflow)
    fasta             = null        // e.g. "db/uniprot.fasta"
    irt_traml         = null        // e.g. "lib/iRTassays.TraML"
    swath_windows     = null        // e.g. "lib/swath32.txt"
    outdir            = "results"
    use_parquet       = false       // Use parquet format for PyProphet processing
    
    // OUTPUT AND CLEANUP
    cleanup_work_dir  = false       // Delete intermediate work files after successful completion
    save_logs         = true        // Publish individual tool logs to results directory
    save_calibration  = true        // Publish calibration report PDF
    save_reports      = true        // Publish PyProphet scoring/inference PDFs
    save_sqmass       = true        // Publish sqMass XIC files from OpenSwathWorkflow
    save_merged_osw   = true        // Publish merged.osw file (before and after alignment)
    save_intermediates = false      // Publish other intermediate files (per-run OSW, pickle files, etc.)

    // RUNTIME
    container         = "ghcr.io/openswath/openswath:dev"
    publish_dir_mode  = "copy"

    // SAGE defaults 
    sage {
      // Search mode
      search_dia_for_lib = false    // Enable searching DIA data with Sage for library building
      
      // Database enzyme settings
      missed_cleavages = 2
      cleave_at = "KR"
      restrict = "P"
      c_terminal = null
      semi_enzymatic = null
      min_len = null
      max_len = null
      
      // Mass tolerances
      precursor_tol_ppm_low = -50.0
      precursor_tol_ppm_high = 50.0
      fragment_tol_ppm_low = -10.0
      fragment_tol_ppm_high = 10.0
      
      // Modifications (JSON format)
      static_mods = '{"C": 57.0216}'        // Carbamidomethyl on Cys
      variable_mods = '{"M": [15.9949]}'      // Oxidation on Met
      max_variable_mods = 2
      
      // Mass ranges
      fragment_min_mz = 150.0
      fragment_max_mz = 1500.0
      peptide_min_mass = 500.0
      peptide_max_mass = 5000.0
      
      // Ion types and charges
      ion_kinds = '["b", "y"]'
      min_ion_index = 2
      precursor_charge_min = 2
      precursor_charge_max = 4
      max_fragment_charge = 1
      
      // Isotope handling
      isotope_errors_min = -1
      isotope_errors_max = 3
      deisotope = true
      
      // Decoys
      decoy_tag = "rev_"
      generate_decoys = true
      
      // Search parameters
      chimera = false
      wide_window = false
      
      // DIA-specific search parameters (used when search_dia_for_lib = true)
      dia_chimera = true            // Enable chimera for DIA
      dia_wide_window = true        // Enable wide window for DIA
      
      min_peaks = 15
      max_peaks = 150
      min_matched_peaks = 4
      report_psms = 1
      predict_rt = true
      
      // Quantification
      tmt = null
      tmt_level = 3
      tmt_sn = false
      lfq = true
      lfq_peak_scoring = "Hybrid"
      lfq_integration = "Sum"
      lfq_spectral_angle = 0.7
      lfq_ppm_tolerance = 5.0
      lfq_combine_charge_states = true
      
      // Output options
      annotate_matches = true  // Generate matched_fragments file
      write_pin = false        // Generate Percolator .pin files
      parquet = false          // Write parquet instead of TSV
      write_report = true
      
      // Runtime
      batch_size = 0           // 0 = auto (CPUs/2)
      bucket_size = 16384
      log_level = "info"       // trace, debug, info, warning, error
    }

    // OpenSwathAssayGenerator defaults
    osag {
      out_type = "pqp"
      min_transitions = 6
      max_transitions = 6
      allowed_fragment_types = "b,y"
      allowed_fragment_charges = "1,2,3,4"
      debug = 0
    }

    // OpenSwathDecoyGenerator defaults
    osdg {
      out_type = "pqp"
      method = "shuffle"
      decoy_tag = "DECOY_"
      allowed_fragment_types = "b,y"
      allowed_fragment_charges = "1,2,3,4"
      switch_kr = true
      debug = 0
    }

    // OpenSWATH defaults (reasonable starting points; tune per setup)
    osw {
      // Extraction window settings
      rt_window_sec   = 600
      extra_rt_window_sec = 200      // when outputing the XICs, include this many extra seconds on either side. This can be useful for adding more context for feature linking when doing chroamtogram alignment.
      mz_win          = 25
      mz_unit         = "ppm"        // "ppm" or "th"
      ms1_mz_win      = 25
      ms1_mz_unit     = "ppm"        // "ppm" or "th"

      pasef           = false        // set true for diaPASEF (adds IM params)
      im_window       = 0.06         // used when pasef=true
      im_extraction_window_ms1 = 0.06 // used when pasef=true
      irt_im_extraction_window = 0.1  // used when pasef=true

      // Calibrant normalization
      auto_irt        = true         // enable iRT normalization
      min_rsq         = 0.95  // Minimum r-squared of RT peptides regression
      linear_irt_bins = 100
      linear_irt_peptides_per_bin = 5
      nonlinear_irt_bins = 2000
      nonlinear_irt_peptides_per_bin = 50

      // Processing options
      cache_in_mem    = true
      batch_size      = 1000

      debug           = 0
    }

    // Arycal defaults
    arycal {
      // XIC settings
      xic_include_precursor = false // Use MS1 traces in alignment
      xic_num_isotopes = 3
      xic_file_type = null          // null = auto-detect, or "sqmass", "parquet"
      
      // Features settings
      features_file_type = null     // null = auto-detect, or "osw", "oswpq"
      
      // Filters
      include_decoys = false
      include_identifying_transitions = false
      max_score_ms2_qvalue = 1.0
      precursor_ids = null          // null or list of specific precursor IDs to selectively align
      
      // Alignment settings
      batch_size = 1000
      alignment_method = "fftdtw"   
      reference_type = "star"       
      reference_run = null          // null = auto-select, or specific run name
      use_tic = true
      
      // Smoothing parameters
      sgolay_window = 11
      sgolay_order = 3
      
      // RT mapping
      rt_mapping_tolerance = 10.0
      decoy_peak_mapping_method = "shuffle"
      decoy_window_size = 30
      
      // Output options
      compute_scores = true
      scores_output_file = null
      retain_alignment_path = false
      
      // Runtime
      log_level = "info"            // trace, debug, info, warning, error
    }

    // PyProphet defaults
    pyprophet {

      alignment_scoring {
        classifier      = "SVM"    // or "LDA, SVM, HistGradientBoosting"
        level           = "alignment"     // ms2|ms1ms2|transition etc.
        threads         = 4
        ss_num_iter     = 3
        ss_initial_fdr  = 0.15
        ss_iteration_fdr = 0.05
        ss_main_score    = 'auto'
        xeval_num_iter   = 3
      }

      peakgroup_scoring {
        classifier      = "XGBoost"    // or "LDA, SVM, HistGradientBoosting"
        level           = "ms1ms2"     // ms2|ms1ms2|transition etc.
        threads         = 4
        ss_num_iter     = 10
        ss_initial_fdr  = 0.15
        ss_iteration_fdr = 0.05
        ss_main_score    = 'auto'
        xeval_num_iter   = 10
      }

      transition_scoring {
        classifier      = "XGBoost"    // or "LDA, SVM, HistGradientBoosting"
        level           = "transition"     // ms2|ms1ms2|transition etc.
        threads         = 4
        ss_num_iter     = 10
        ss_initial_fdr  = 0.15
        ss_iteration_fdr = 0.05
        ss_main_score    = 'auto'
        xeval_num_iter   = 10
        ipf_max_peakgroup_rank  = 1
        ipf_max_peakgroup_pep = 0.7
        ipf_max_transition_isotope_overlap = 0.5
        ipf_min_transition_sn = -1
      }

      infer_peptidoforms {
        ipf_ms1_scoring = false 
        ipf_ms2_scoring = false
        ipf_max_precursor_pep = 0.7
        ipf_max_peakgroup_pep = 0.7
        ipf_max_precursor_peakgroup_pep = 0.4
        ipf_max_transition_pep = 0.6
        propagate_signal_across_runs = true
        ipf_max_alignment_pep = 0.4
        across_run_confidence_threshold = 0.5
      }

      pyprophet_export_tsv {
        max_rs_peakgroup_qvalue = 0.05
        max_global_peptide_qvalue = 0.01
        max_global_protein_qvalue = 0.01
      }
    }
}

// Load base.config by default for all pipelines
includeConfig 'conf/base.config'


// add to nextflow.config
process {
  container = 'ghcr.io/openswath/openswath:latest'
}