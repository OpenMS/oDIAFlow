// Test configuration for EASYPQP modules
// Includes Sage search configuration since it runs first

params {
  sage {
    // Database search parameters - reduced for faster testing
    missed_cleavages = 1
    min_len = 7
    max_len = 30
    cleave_at = "KR"
    restrict = "P"
    c_terminal = true
    semi_enzymatic = false
    
    // Mass tolerances - wider for test data
    precursor_tol_ppm_low = -50.0
    precursor_tol_ppm_high = 50.0
    fragment_tol_ppm_low = -20.0
    fragment_tol_ppm_high = 20.0
    
    // Modifications
    static_mods = '{"C": 57.0216}'        // Carbamidomethyl on Cys
    variable_mods = '{"M": [15.9949]}'    // Oxidation on Met
    max_variable_mods = 2
    
    // Mass ranges
    fragment_min_mz = 150.0
    fragment_max_mz = 1500.0
    peptide_min_mass = 500.0
    peptide_max_mass = 5000.0
    
    // Ion types and charges
    ion_kinds = '["b", "y"]'
    min_ion_index = 2
    precursor_charge_min = 2
    precursor_charge_max = 4
    max_fragment_charge = 1
    
    // Isotope handling
    isotope_errors_min = -1
    isotope_errors_max = 3
    deisotope = true
    
    // Decoys
    decoy_tag = "rev_"
    generate_decoys = true
    
    // Search parameters
    chimera = false
    wide_window = false
    min_peaks = 12
    max_peaks = 150
    min_matched_peaks = 4
    report_psms = 1
    predict_rt = true
    
    // Quantification - disabled for test
    tmt = null
    tmt_level = 3
    tmt_sn = false
    lfq = false
    
    // Output options - MUST enable annotate_matches for EasyPQP
    annotate_matches = true      // Required for matched_fragments output
    write_pin = false
    parquet = false
    
    // Runtime
    batch_size = 0
    bucket_size = 8192
    log_level = "info"
  }
}

process {
  withName: SAGE_SEARCH {
    cpus = 4
    memory = '8.GB'
    time = '1.h'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }

  withName: EASYPQP_CONVERTSAGE {
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }

  withName: EASYPQP_LIBRARY {
    ext.args = '--nofdr --psm_fdr_threshold 1.0 --peptide_fdr_threshold 1.0 --protein_fdr_threshold 1.0 --rt_psm_fdr_threshold 1.0 --min_peptides 1'
    cpus = 2
    memory = '4.GB'
    time = '30.m'
    containerOptions = '--env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
  }
}

profiles {
  docker {
    docker.enabled = true
    docker.runOptions = '-u $(id -u):$(id -g) --env HOME=/tmp --env MPLCONFIGDIR=/tmp/matplotlib --env DUCKDB_HOME=/tmp/duckdb'
    singularity.enabled = false
  }
  
  singularity {
    singularity.enabled = true
    singularity.autoMounts = true
    docker.enabled = false
  }
}
